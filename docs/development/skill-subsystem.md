# 技能子系统文档

## 概述

Dawei 中的**技能子系统**是一个知识管理和指导系统，为 AI 代理提供特定领域的专业知识。技能是结构化的指令集，以 markdown 文件形式存储，指导代理如何有效执行专业任务。

## 什么是技能？

**技能**是一个专门的知识包，由以下部分组成：

1. **SKILL.md** - 主技能定义文件，包含：
   - **Frontmatter（前置元数据）**：元数据（名称、描述、版本等）
   - **指令**：详细的工作流程、最佳实践、代码示例
   - **指导**：特定任务的分步程序

2. **资源**（可选） - 同一目录中的支持文件：
   - 模板
   - 代码示例
   - 参考资料
   - 配置文件

### 技能文件格式

```markdown
---
name: pdf
description: PDF 处理和提取工作流
version: 1.0.0
---

# PDF 处理技能

## 概述
本技能为...提供全面指导

## 工作流
1. 第一步...
2. 第二步...

## 代码示例
\`\`\`python
# 示例代码
\`\`\`
```

## 架构

### 存储位置

技能存储在分层结构中，采用基于优先级的解析机制：

```
.dawei/
├── skills/                    # 通用技能
│   ├── pdf/
│   │   └── SKILL.md
│   ├── xlsx/
│   │   ├── SKILL.md
│   │   └── templates/
│   │       └── invoice.xlsx
│   └── frontend-design/
│       └── SKILL.md
├── skills-web/               # 特定模式技能
│   └── responsive/
│       └── SKILL.md
```

### 优先级顺序（从高到低）

1. **工作空间通用**：`{workspace}/.dawei/skills/`
2. **工作空间模式特定**：`{workspace}/.dawei/skills-{mode}/`
3. **全局系统**：`{DAWEI_HOME}/skills/`
4. **全局用户**：`{DAWEI_HOME}/.dawei/skills/`
5. **全局模式特定**：`{DAWEI_HOME}/skills-{mode}/`

高优先级技能覆盖同名的低优先级技能。

## 核心组件

### 1. SkillManager (`skill_manager.py`)

管理技能发现、加载和检索的中心类。

#### 关键方法

| 方法 | 描述 |
|------|------|
| `discover_skills()` | 扫描所有根目录以查找技能 |
| `get_all_skills()` | 返回所有已发现的技能（按优先级排序） |
| `find_matching_skills(query)` | 通过关键词匹配搜索技能 |
| `get_skill_content(skill_name)` | 加载完整的技能内容（延迟加载） |
| `get_skill_resources(skill_name)` | 返回技能的资源文件 |

#### 技能数据模型

```python
@dataclass
class Skill:
    name: str                              # 唯一标识符
    description: str                        # 简要描述
    scope: Literal['workspace', 'system', 'user']  # 来源
    mode: str | None                        # 模式特定性
    directory: Path                         # 技能目录路径
    content: str | None = None              # 延迟加载的内容
    resources: list[Path] | None = None     # 资源文件
    priority: int = 0                       # 加载优先级
```

### 2. 渐进式加载策略

技能系统使用三层加载方法：

1. **发现阶段**（快速）
   - 仅从 SKILL.md 读取 frontmatter
   - 最小化 I/O 以实现快速启动
   - 构建技能注册表

2. **内容加载**（按需）
   - 代理请求时加载完整的 SKILL.md
   - 使用 `get_skill_content()` 方法
   - 首次加载后缓存内容

3. **资源访问**（按需）
   - 扫描目录中的其他文件
   - 通过 `read_skill_resource()` 工具访问
   - 支持模板、示例、配置

### 3. 技能工具 (`skills_tool.py`)

代理用于与技能交互的工具：

| 工具 | 用途 |
|------|------|
| `list_skills` | 显示所有可用技能及其元数据 |
| `search_skills` | 查找与查询匹配的技能 |
| `get_skill` | 加载完整的技能指令 |
| `list_skill_resources` | 显示技能的资源文件 |
| `read_skill_resource` | 读取特定资源文件内容 |

### 4. API 端点 (`skills.py`)

用于技能管理的 REST API：

```
GET    /api/skills/list                    # 列出所有技能
GET    /api/skills/search/{query}          # 搜索技能
GET    /api/skills/skill/{skill_name}      # 获取技能元数据
GET    /api/skills/skill/{skill_name}/content    # 获取技能内容
POST   /api/skills/skill                   # 创建新技能
PUT    /api/skills/skill/{skill_name}      # 更新技能
DELETE /api/skills/skill/{skill_name}      # 删除技能
```

## 技能使用流程

### 使用技能的代理执行

```
┌──────────────────────────────────────────────────────────────────┐
│                         用户请求                                  │
└──────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────┐
│  代理: search_skills(query="从 PDF 提取表格")                     │
└──────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────┐
│  SkillManager: find_matching_skills()                            │
│  → 返回: [pdf 技能 (描述: "...表格提取...")]                     │
└──────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────┐
│  代理: get_skill(skill_name="pdf")                               │
└──────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────┐
│  SkillManager: get_skill_content("pdf")                          │
│  → 返回: 包含工作流的完整 SKILL.md 内容                           │
└──────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────┐
│  代理: 遵循技能指令                                               │
│  1. 使用 pdf2image 工具进行转换                                   │
│  2. 使用 pytesseract 工具进行 OCR                                │
│  3. 使用 pandas 工具进行表格提取                                 │
└──────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────┐
│                         结果交付                                  │
└──────────────────────────────────────────────────────────────────┘
```

## 技能与工具

### 主要区别

| 方面 | 工具 | 技能 |
|------|------|------|
| **性质** | 可执行函数 | 指令集 |
| **用途** | 执行操作 | 指导如何使用工具 |
| **实现** | Python 函数 | Markdown 文档 |
| **执行** | 直接调用 | 代理遵循指令 |
| **示例** | `extract_pdf()` | 如何结合 OCR + 表格提取 |

### 关系

- **工具**提供能力
- **技能**提供使用这些能力的专业知识
- 技能补充工具，而不是替代它们
- 技能是提升代理性能的"知识资产"

## 配置

### 环境变量

| 变量 | 描述 | 默认值 |
|------|------|--------|
| `DAWEI_HOME` | 全局技能的基础目录 | `~/.dawei` |
| `DAWEI_WORKSPACE` | 当前工作空间路径 | `./` |

### 工作空间模式

技能可以针对特定模式以支持不同的工作流：

- `web` - Web 开发技能
- `data` - 数据分析技能
- `dev` - 通用开发技能

当该模式处于活动状态时，特定模式的技能覆盖通用技能。

## 创建自定义技能

### 目录结构

```bash
mkdir -p .dawei/skills/my-skill
cat > .dawei/skills/my-skill/SKILL.md << 'EOF'
---
name: my-skill
description: 用于专业任务的自定义技能
version: 1.0.0
---

# 我的自定义技能

## 用途
本技能帮助...

## 前置条件
- 已安装工具 1
- 已配置工具 2

## 工作流
1. 第一步...
2. 第二步...

## 示例
\`\`\`python
# 代码示例
\`\`\`
EOF
```

### 最佳实践

1. **清晰描述**：Frontmatter 描述应可搜索
2. **分步工作流**：分解复杂任务
3. **代码示例**：提供可用的示例
4. **前置条件**：列出所需的工具/配置
5. **错误处理**：包含常见问题和解决方案
6. **资源**：在有帮助时添加模板或参考文件

## 安全考虑

### 路径验证

- 所有技能路径都经过验证以防止目录遍历
- 工作空间技能与系统路径隔离
- 系统级技能受保护，无法修改

### 访问控制

- 工作空间技能：可由用户创建/修改/删除
- 系统技能：只读（无法通过 API 删除）
- 用户级技能：可由用户管理

## 集成点

### 与代理系统

1. **代理上下文**：在初始化时将技能加载到代理上下文中
2. **工具执行器**：代理执行期间技能工具可用
3. **提示模板**：`skills.j2` 在系统提示中提供技能指导

### 与工作空间

1. **UserWorkspace**：将技能工具集成到工作空间操作中
2. **工作空间结构**：`.dawei/skills/` 是工作空间布局的一部分
3. **模式支持**：工作空间模式影响技能解析

### 与 TUI

1. **SkillAwareInput**：TUI 小部件支持 `@skill:` 语法高亮
2. **快速访问**：TUI 提供技能发现和浏览

## 性能特征

### 发现性能

- **延迟 Frontmatter**：发现期间仅读取 YAML frontmatter
- **选择性加载**：仅在需要时加载完整内容
- **缓存**：已发现的技能在 SkillManager 中缓存

### 搜索性能

- **关键词匹配**：简单的字符串匹配用于搜索
- **优先级排序**：结果首先按优先级排序
- **无索引**：直接文件扫描（对于典型技能数量足够）

## 故障排除

### 常见问题

**问题**：技能未出现在列表中
- **解决方案**：检查 SKILL.md frontmatter 格式
- **解决方案**：验证目录名称与 frontmatter 中的 `name` 匹配

**问题**：低优先级技能覆盖高优先级技能
- **解决方案**：检查范围定义（工作空间 > 系统 > 用户）

**问题**：资源无法访问
- **解决方案**：验证文件与 SKILL.md 在同一目录中
- **解决方案**：检查文件权限

## 未来增强

技能系统的潜在改进：

1. **技能版本控制**：支持同一技能的多个版本
2. **技能依赖**：需要其他技能的技能
3. **技能索引**：跨技能内容的全文搜索
4. **技能验证**：自动验证技能质量
5. **技能市场**：从社区分享和发现技能
6. **技能组合**：将多个技能组合成工作流

## 参考

- **实现**：`agent/dawei/tools/skill_manager.py`
- **工具**：`agent/dawei/tools/custom_tools/skills_tool.py`
- **API**：`agent/dawei/api/skills.py`
- **提示模板**：`agent/dawei/prompts/skills.j2`
- **TUI 集成**：`agent/dawei/tui/widgets/skill_aware_input.py`
