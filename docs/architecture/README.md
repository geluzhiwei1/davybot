# Dawei æ¶æ„æ–‡æ¡£ç´¢å¼•

æœ¬ç›®å½•åŒ…å« Dawei Agent ç³»ç»Ÿçš„å®Œæ•´æ¶æ„æ–‡æ¡£å’Œå›¾è¡¨ã€‚

## ğŸ“Š æ¶æ„å›¾æ–‡æ¡£

### 1. [Mermaid æ¶æ„å›¾](./architecture-diagrams.md)
**æ¨èç”¨äº**: GitHub/GitLab åœ¨çº¿é¢„è§ˆã€Markdown æ–‡æ¡£

åŒ…å«ä»¥ä¸‹å›¾è¡¨ï¼š
- âœ… ç³»ç»Ÿåˆ†å±‚æ¶æ„å›¾ï¼ˆ7å±‚ï¼‰
- âœ… 3C å›¾ï¼ˆComponent-Class-Connectionï¼‰
- âœ… è¯¦ç»†ç±»å…³ç³»å›¾
- âœ… æ¨¡å—ä¾èµ–å…³ç³»å›¾
- âœ… Agent æ‰§è¡Œæµç¨‹å›¾
- âœ… WebSocket æ¶ˆæ¯æµå›¾
- âœ… å·¥å…·å‘ç°å’Œæ‰§è¡Œæµç¨‹å›¾
- âœ… PDCA æ¨¡å¼ç³»ç»Ÿå›¾
- âœ… æ•°æ®æµå›¾
- âœ… é…ç½®åŠ è½½å±‚çº§å›¾
- âœ… äº‹ä»¶é©±åŠ¨æ¶æ„å›¾
- âœ… æ’ä»¶ç³»ç»Ÿæ¶æ„å›¾
- âœ… è®°å¿†ç³»ç»Ÿæ¶æ„å›¾
- âœ… æŠ€èƒ½ç³»ç»Ÿæ¶æ„å›¾
- âœ… å…³é”®æŒ‡æ ‡ç»Ÿè®¡
- âœ… æ ¸å¿ƒè®¾è®¡åŸåˆ™
- âœ… æ¶æ„æ¨¡å¼

### 2. [PlantUML æ¶æ„å›¾](./architecture-plantuml.puml)
**æ¨èç”¨äº**: æœ¬åœ°æ¸²æŸ“ã€é«˜è´¨é‡å¯¼å‡ºã€IDE æ’ä»¶é¢„è§ˆ

åŒ…å«ä»¥ä¸‹å›¾è¡¨ï¼š
- âœ… ç³»ç»Ÿåˆ†å±‚æ¶æ„å›¾ï¼ˆArchimateé£æ ¼ï¼‰
- âœ… 3C å›¾ï¼ˆ5ä¸ªæ ¸å¿ƒç»„ä»¶çš„è¯¦ç»†ç±»å›¾ï¼‰
- âœ… Agent æ‰§è¡Œæµç¨‹åºåˆ—å›¾
- âœ… å·¥å…·ç³»ç»Ÿæ¶æ„å›¾ï¼ˆ4å±‚é…ç½®ï¼‰
- âœ… PDCA æ¨¡å¼ç³»ç»Ÿå›¾
- âœ… äº‹ä»¶é©±åŠ¨æ¶æ„å›¾
- âœ… æŠ€èƒ½ç³»ç»Ÿæ¶æ„å›¾ï¼ˆæ¸è¿›å¼åŠ è½½ï¼‰
- âœ… æ¨¡å—ä¾èµ–å…³ç³»å›¾

## ğŸ¯ æ ¸å¿ƒæ¶æ„æ¦‚è§ˆ
### 7 å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Layer 7: UI Layer                     â”‚  CLI, TUI, REST API
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Layer 6: Communication Layer          â”‚  WebSocket, AsyncTask, A2UI
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Layer 5: Agent Layer                  â”‚  Agent, TaskGraph, Mode, Memory
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Layer 4: Tool Layer                   â”‚  Tools, Skills, Sandbox, MCP
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Layer 3: LLM Layer                    â”‚  LLMProvider, ModelRouter, Prompts
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Layer 2: Data Layer                   â”‚  Storage, Workspace, Conversation
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Layer 1: Infrastructure Layer         â”‚  EventBus, DI, Config, Logger
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. Agent System (æ™ºèƒ½ä½“ç³»ç»Ÿ)
- **Agent** (agentic/agent.py) - æ ¸å¿ƒæ™ºèƒ½ä½“ç±»
- **TaskGraphExecutionEngine** - ä»»åŠ¡å›¾æ‰§è¡Œå¼•æ“
- **TaskNodeExecutionEngine** - ä»»åŠ¡èŠ‚ç‚¹æ‰§è¡Œå¼•æ“
- **CheckpointManager** - æ£€æŸ¥ç‚¹ç®¡ç†å™¨
- **ContextManager** - ä¸Šä¸‹æ–‡ç®¡ç†å™¨

#### 2. Tool System (å·¥å…·ç³»ç»Ÿ)
- **ToolManager** - 4å±‚å·¥å…·é…ç½®ç®¡ç†
- **ToolExecutor** - å·¥å…·æ‰§è¡Œå¼•æ“
- **SkillManager** - æŠ€èƒ½ç®¡ç†å™¨ï¼ˆæ¸è¿›å¼åŠ è½½ï¼‰
- **CustomBaseTool** - è‡ªå®šä¹‰å·¥å…·åŸºç±»

#### 3. LLM Integration (å¤§æ¨¡å‹é›†æˆ)
- **LLMProvider** - å¤šæä¾›å•†æŠ½è±¡å±‚
- **ModelRouter** - æ™ºèƒ½æ¨¡å‹è·¯ç”±
- **CircuitBreaker** - ç†”æ–­å™¨
- **RateLimiter** - é€Ÿç‡é™åˆ¶å™¨

#### 4. Communication (é€šä¿¡å±‚)
- **WebSocketManager** - WebSocket è¿æ¥ç®¡ç†
- **MessageRouter** - æ¶ˆæ¯è·¯ç”±å™¨
- **MessageProtocol** - æ¶ˆæ¯åè®®ï¼ˆ40+ æ¶ˆæ¯ç±»å‹ï¼‰

#### 5. Infrastructure (åŸºç¡€è®¾æ–½)
- **EventBus** - äº‹ä»¶æ€»çº¿ï¼ˆå‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼‰
- **DependencyContainer** - ä¾èµ–æ³¨å…¥å®¹å™¨
- **Settings** - é…ç½®ç®¡ç†

### PDCA æ¨¡å¼ç³»ç»Ÿ

```
Orchestrator (ä¼˜å…ˆçº§ 90) ğŸªƒ
    â†“ ç®¡ç†
Plan (ä¼˜å…ˆçº§ 80) ğŸ“‹        â†’  Read-Only æ¨¡å¼
    â†“ è®¡åˆ’
Do (ä¼˜å…ˆçº§ 70) âš™ï¸           â†’  æ‰§è¡Œæ¨¡å¼
    â†“ æ‰§è¡Œ
Check (ä¼˜å…ˆçº§ 75) âœ“         â†’  éªŒè¯æ¨¡å¼
    â†“ æ£€æŸ¥
Act (ä¼˜å…ˆçº§ 78) ğŸš€          â†’  æ”¹è¿›æ¨¡å¼
    â†“ æ”¹è¿›
Plan (å¾ªç¯) ğŸ“‹
```

### 4 å±‚é…ç½®åŠ è½½

```
Priority 1: Workspace (workspace/.dawei/)  â† æœ€é«˜ä¼˜å…ˆçº§
Priority 2: User (~/.dawei/)
Priority 3: System (/etc/dawei/)
Priority 4: Builtin (dawei/)               â† æœ€ä½ä¼˜å…ˆçº§
```

é€‚ç”¨äºï¼š
- å·¥å…·é…ç½®
- æ¨¡å¼é…ç½®
- æŠ€èƒ½é…ç½®
- LLM é…ç½®
- æ’ä»¶é…ç½®

### æ¸è¿›å¼æŠ€èƒ½åŠ è½½

```
Level 1: Discovery  - ä»…åŠ è½½ frontmatter (name, description)
    â†“ æŒ‰éœ€åŠ è½½
Level 2: Instructions - åŠ è½½å®Œæ•´ SKILL.md å†…å®¹
    â†“ æŒ‰éœ€åŠ è½½
Level 3: Resources    - è®¿é—®èµ„æºæ–‡ä»¶ (reference.md, templates/)
```

### äº‹ä»¶é©±åŠ¨æ¶æ„

```
Event Publishers (äº‹ä»¶å‘å¸ƒè€…)
    â†“ publish
EventBus (äº‹ä»¶æ€»çº¿)
    â†“ notify
Event Subscribers (äº‹ä»¶è®¢é˜…è€…)
    - WebSocket Handlers
    - CheckpointManager
    - Metrics Collector
    - Logger
    - TUI Handler
```

## ğŸ”§ æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **KISS** (Keep It Simple, Stupid) - ç®€åŒ–çš„å®ç°
2. **DRY** (Don't Repeat Yourself) - ä»£ç å¤ç”¨
3. **Fast Fail** - å¿«é€Ÿå¤±è´¥åŸåˆ™
4. **Interface Segregation** - æ¥å£éš”ç¦»
5. **Single Responsibility** - å•ä¸€èŒè´£
6. **Open/Closed** - å¼€é—­åŸåˆ™
7. **Dependency Inversion** - ä¾èµ–å€’ç½®

## ğŸ—ï¸ æ¶æ„æ¨¡å¼

- **åˆ†å±‚æ¶æ„** - æ¸…æ™°çš„å…³æ³¨ç‚¹åˆ†ç¦»
- **äº‹ä»¶é©±åŠ¨æ¶æ„** - EventBus å®ç°æ¾è€¦åˆ
- **ä¾èµ–æ³¨å…¥** - DependencyContainer ç®¡ç†æœåŠ¡
- **ä»“å‚¨æ¨¡å¼** - å­˜å‚¨æŠ½è±¡å±‚
- **ç­–ç•¥æ¨¡å¼** - å¤š LLM æä¾›å•†ã€å·¥å…·æ‰§è¡Œå™¨
- **è§‚å¯Ÿè€…æ¨¡å¼** - EventBus è®¢é˜…è€…
- **å·¥å‚æ¨¡å¼** - å·¥å…·å·¥å‚ã€å®¢æˆ·ç«¯å·¥å‚
- **å»ºé€ è€…æ¨¡å¼** - A2UI å»ºé€ å™¨ã€æç¤ºæ„å»ºå™¨
- **æ¨¡æ¿æ–¹æ³•** - åŸºç¡€å¤„ç†å™¨ã€åŸºç¡€å·¥å…·
- **é€‚é…å™¨æ¨¡å¼** - å­˜å‚¨é€‚é…å™¨ã€LLM é€‚é…å™¨

## ğŸ“¦ æ¨¡å—ç»„ç»‡

```
dawei/
â”œâ”€â”€ Core Infrastructure (åŸºç¡€è®¾æ–½)
â”‚   â”œâ”€â”€ core/              - äº‹ä»¶ç³»ç»Ÿã€DIã€é”™è¯¯å¤„ç†ã€æŒ‡æ ‡
â”‚   â”œâ”€â”€ interfaces/        - 6ä¸ªæ ¸å¿ƒæ¥å£
â”‚   â”œâ”€â”€ config/            - é…ç½®ç®¡ç†ï¼ˆPydantic Settingsï¼‰
â”‚   â”œâ”€â”€ logg/              - UTF-8æ—¥å¿—ç³»ç»Ÿ
â”‚   â””â”€â”€ entity/            - æ•°æ®æ¨¡å‹
â”‚
â”œâ”€â”€ Agent System (æ™ºèƒ½ä½“ç³»ç»Ÿ)
â”‚   â”œâ”€â”€ agentic/           - æ ¸å¿ƒæ™ºèƒ½ä½“ç¼–æ’ï¼ˆ23ä¸ªæ–‡ä»¶ï¼‰
â”‚   â”œâ”€â”€ mode/              - PDCA æ¨¡å¼ç³»ç»Ÿ
â”‚   â”œâ”€â”€ task_graph/        - ä»»åŠ¡å›¾æ‰§è¡Œå¼•æ“
â”‚   â””â”€â”€ memory/            - DaweiMem è®°å¿†ç³»ç»Ÿ
â”‚
â”œâ”€â”€ Tool System (å·¥å…·ç³»ç»Ÿ)
â”‚   â”œâ”€â”€ tools/             - å¤šå±‚å·¥å…·ç®¡ç†ï¼ˆ50+ å·¥å…·ï¼‰
â”‚   â”œâ”€â”€ sandbox/           - å®‰å…¨æ‰§è¡Œç¯å¢ƒ
â”‚   â””â”€â”€ a2ui/              - Agent-to-User æ¥å£
â”‚
â”œâ”€â”€ Communication (é€šä¿¡å±‚)
â”‚   â”œâ”€â”€ websocket/         - WebSocket æœåŠ¡å™¨ï¼ˆ13ä¸ªå¤„ç†å™¨ï¼‰
â”‚   â””â”€â”€ async_task/        - å¼‚æ­¥ä»»åŠ¡ç®¡ç†
â”‚
â”œâ”€â”€ LLM Integration (å¤§æ¨¡å‹é›†æˆ)
â”‚   â”œâ”€â”€ llm_api/           - LLM æä¾›å•†æŠ½è±¡å±‚
â”‚   â””â”€â”€ prompts/           - Jinja2 æ¨¡æ¿ç³»ç»Ÿ
â”‚
â”œâ”€â”€ Data & Storage (æ•°æ®å­˜å‚¨)
â”‚   â”œâ”€â”€ storage/           - å­˜å‚¨æŠ½è±¡å±‚
â”‚   â”œâ”€â”€ conversation/      - ä¼šè¯ç®¡ç†
â”‚   â””â”€â”€ workspace/         - å·¥ä½œç©ºé—´ç®¡ç†ï¼ˆ14ä¸ªæ–‡ä»¶ï¼‰
â”‚
â”œâ”€â”€ API Layer (APIå±‚)
â”‚   â””â”€â”€ api/               - FastAPI è·¯ç”±ï¼ˆ14ä¸ªç«¯ç‚¹ï¼‰
â”‚
â”œâ”€â”€ Extensibility (æ‰©å±•æ€§)
â”‚   â”œâ”€â”€ plugins/           - æ’ä»¶ç³»ç»Ÿï¼ˆ4å±‚å‘ç°ï¼‰
â”‚   â””â”€â”€ market/            - å¸‚åœºé›†æˆ
â”‚
â””â”€â”€ User Interfaces (ç”¨æˆ·ç•Œé¢)
    â”œâ”€â”€ cli/               - ç»Ÿä¸€ CLIï¼ˆdawei å‘½ä»¤ï¼‰
    â””â”€â”€ tui/               - ç»ˆç«¯ UIï¼ˆtextual>=0.80.0ï¼‰
```

## ğŸ”„ æ ¸å¿ƒæµç¨‹

### Agent æ‰§è¡Œæµç¨‹

```
User â†’ WebSocket â†’ Agent
                    â†“
            TaskGraphExecutionEngine
                    â†“
            TaskNodeExecutionEngine
                    â†“
                LLM Provider
                    â†“
            (å¯èƒ½éœ€è¦å·¥å…·è°ƒç”¨)
                    â†“
            Tool Executor
                    â†“
            EventBus (å‘å¸ƒäº‹ä»¶)
                    â†“
                WebSocket
                    â†“
                User
```

### å·¥å…·å‘ç°æµç¨‹

```
ToolManager
    â†“ 4å±‚åŠ è½½
builtin â†’ system â†’ user â†’ workspace
    â†“ å·¥å…·æä¾›è€…æ³¨å†Œ
ToolProvider Registry
    â†“ æ¨¡å¼è¿‡æ»¤
Mode-based Filtering
    â†“ å·¥å…·æ‰§è¡Œ
ToolExecutor
```
